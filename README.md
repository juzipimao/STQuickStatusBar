# STQuickStatusBar å¯è§†åŒ–è®¾è®¡å™¨

## é¡¹ç›®æ¦‚è¿°

STQuickStatusBar å¯è§†åŒ–è®¾è®¡å™¨æ˜¯ä¸€ä¸ªåŸºäº SillyTavern æ‰©å±•ç³»ç»Ÿçš„åŠ¨æ€HTMLæ§ä»¶ç¼–è¾‘å™¨ï¼Œæ”¯æŒAIé©±åŠ¨çš„æ•°å€¼å˜åŒ–ç³»ç»Ÿã€‚é€šè¿‡ä¸ä¸–ç•Œä¹¦é›†æˆï¼Œå¯ä»¥åˆ›å»ºæ™ºèƒ½çš„çŠ¶æ€é¢æ¿ï¼Œæ ¹æ®AIå›å¤è‡ªåŠ¨æ›´æ–°æ•°å€¼æ˜¾ç¤ºã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…æ–¹æ³•

1. å°†æ’ä»¶æ–‡ä»¶å¤¹å¤åˆ¶åˆ° SillyTavern çš„ `extensions` ç›®å½•ä¸­
2. é‡å¯ SillyTavern
3. åœ¨æ‰©å±•ç®¡ç†å™¨ä¸­å¯ç”¨ STQuickStatusBar

### æµ‹è¯•å®‰è£…

#### æ–¹æ³•1: ä½¿ç”¨æµ‹è¯•è„šæœ¬
- **Windows**: è¿è¡Œ `test.bat`
- **Linux/Mac**: è¿è¡Œ `bash test.sh`

#### æ–¹æ³•2: æ‰‹åŠ¨æµ‹è¯•
1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `debug.html`
2. ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®éªŒè¯åŠŸèƒ½

### ä½¿ç”¨æ–¹æ³•

1. **å¯åŠ¨è®¾è®¡å™¨**: åœ¨ SillyTavern ä¸­ç‚¹å‡»å¿«é€Ÿæ çš„è®¾è®¡å™¨æŒ‰é’®
2. **æ‹–æ‹½æ§ä»¶**: ä»å·¦ä¾§æ§ä»¶åº“æ‹–æ‹½æ§ä»¶åˆ°é¢„è§ˆåŒºåŸŸ
3. **è°ƒæ•´å¸ƒå±€**: ç‚¹å‡»æ§ä»¶å³ä¸Šè§’çš„ç»¿è‰²ç§»åŠ¨æŒ‰é’®è¿›è¡ŒäºŒæ¬¡æ‹–æ‹½é‡æ’åº
4. **è®¾ç½®å±æ€§**: åœ¨å³ä¾§å±æ€§é¢æ¿ä¸­è°ƒæ•´æ§ä»¶å±æ€§
5. **æ’å…¥ä¸–ç•Œä¹¦**: ç‚¹å‡»"æ’å…¥ä¸–ç•Œä¹¦"æŒ‰é’®ï¼Œè®©AIèƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°æ•°å€¼

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¯è§†åŒ–è®¾è®¡å™¨
- æ‹–æ‹½å¼ç•Œé¢è®¾è®¡
- å®æ—¶é¢„è§ˆå’Œä»£ç ç”Ÿæˆ
- å®Œæ•´çš„æ§ä»¶åº“ï¼ˆæ–‡æœ¬ã€æ•°å€¼ã€å¤åˆæ§ä»¶ï¼‰
- æ”¯æŒæ§ä»¶é‡æ’åºå’ŒäºŒæ¬¡æ‹–æ‹½

### 2. AIé©±åŠ¨çš„åŠ¨æ€æ•°å€¼ç³»ç»Ÿ
- æ™ºèƒ½è§£æAIå›å¤ä¸­çš„æ•°å€¼å˜åŒ–æŒ‡ä»¤
- è‡ªåŠ¨æ›´æ–°ç•Œé¢æ˜¾ç¤º
- æ”¯æŒå¤šç§æŒ‡ä»¤æ ¼å¼ï¼ˆå¢å‡ã€è®¾ç½®ã€åˆ é™¤ç­‰ï¼‰
- å®æ—¶åŠ¨ç”»æ•ˆæœå’Œå˜åŒ–æç¤º

### 3. ä¸–ç•Œä¹¦é›†æˆ
- è‡ªåŠ¨ç”Ÿæˆæç¤ºè¯æ¨¡æ¿
- å¼•å¯¼AIè¾“å‡ºæ ‡å‡†åŒ–æŒ‡ä»¤
- æ”¯æŒå¤šç§åœºæ™¯æ¨¡æ¿ï¼ˆè§’è‰²æ‰®æ¼”ã€æ¸¸æˆç³»ç»Ÿã€ç”Ÿå­˜æ¨¡æ‹Ÿï¼‰
- æ·±åº¦é›†æˆSillyTavernçš„ä¸–ç•Œä¹¦ç³»ç»Ÿ

### 4. å®æ—¶çŠ¶æ€æ˜¾ç¤º
- æ‚¬æµ®çŠ¶æ€é¢æ¿
- æ”¯æŒæ‹–æ‹½å’ŒæŠ˜å 
- è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤çŠ¶æ€
- å¤šè§’è‰²çŠ¶æ€ç®¡ç†

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ’ä»¶æœªæ˜¾ç¤ºåœ¨æ‰©å±•åˆ—è¡¨ä¸­**
   - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ”¾ç½®åœ¨ extensions ç›®å½•
   - ç¡®è®¤ manifest.json æ ¼å¼æ­£ç¡®
   - é‡å¯ SillyTavern

2. **JavaScript é”™è¯¯**
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
   - ç¡®è®¤ SillyTavern ç‰ˆæœ¬å…¼å®¹æ€§
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ‰©å±•å†²çª

3. **å…¨å±€å¯¹è±¡æœªå®šä¹‰é”™è¯¯**
   - ç¡®è®¤ SillyTavern å·²å®Œå…¨åŠ è½½
   - æ£€æŸ¥æ’ä»¶åŠ è½½é¡ºåº
   - éªŒè¯ SillyTavern ç‰ˆæœ¬æ˜¯å¦æ”¯æŒæ‰€éœ€çš„å…¨å±€å¯¹è±¡

4. **æ§ä»¶æ— æ³•æ‹–æ‹½**
   - ç¡®è®¤å·²åˆ›å»ºæ§ä»¶å¹¶æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ
   - ç‚¹å‡»æ§ä»¶å³ä¸Šè§’çš„ç»¿è‰²ç§»åŠ¨æŒ‰é’®ï¼ˆç®­å¤´å›¾æ ‡ï¼‰
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ‹–æ‹½åº“å†²çª

### è°ƒè¯•æ¨¡å¼

åœ¨ SillyTavern æ§åˆ¶å°ä¸­æ‰§è¡Œï¼š
```javascript
// å¯ç”¨è°ƒè¯•æ¨¡å¼
if (window.STQuickStatusBar) {
    window.STQuickStatusBar.settings.debugMode = true;
}

// æŸ¥çœ‹æ’ä»¶çŠ¶æ€
console.log(window.STQuickStatusBar?.getStatus());

// è¿è¡Œå®Œæ•´çŠ¶æ€æ£€æŸ¥
checkSTQuickStatusBar();
```

### ä½¿ç”¨è°ƒè¯•å·¥å…·

1. æ‰“å¼€ `debug.html` æ–‡ä»¶
2. ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"æŒ‰é’®
3. æŸ¥çœ‹çŠ¶æ€æŒ‡ç¤ºå™¨å’Œè°ƒè¯•æ—¥å¿—
4. æ ¹æ®é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®å¤

## ğŸ“‹ ç‰ˆæœ¬æ›´æ–°è®°å½•

### v1.0.0 (2024-01-XX)
- âœ… ä¿®å¤å…¨å±€å¯¹è±¡è®¿é—®é”™è¯¯
- âœ… å®ç°å®‰å…¨çš„ getSillyTavernGlobals() è®¿é—®æ¨¡å¼
- âœ… å®Œå–„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
- âœ… æ·»åŠ å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… å®ç°æ§ä»¶äºŒæ¬¡æ‹–æ‹½é‡æ’åºåŠŸèƒ½
- âœ… æ·»åŠ æ‹–æ‹½è§†è§‰åé¦ˆå’ŒåŠ¨ç”»æ•ˆæœ
- âœ… å®Œå–„è°ƒè¯•å·¥å…·å’ŒçŠ¶æ€æ£€æŸ¥ç³»ç»Ÿ

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. SillyTavern ç‰ˆæœ¬
2. æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬
3. æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
4. å¤ç°æ­¥éª¤
5. è°ƒè¯•å·¥å…·çš„è¾“å‡ºç»“æœ

---

## å¢å¼ºåŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
1. **æ¨¡æ€æ¡†ç•Œé¢** - ç‚¹å‡»æ’ä»¶åå¼¹å‡ºå¯è§†åŒ–è®¾è®¡å™¨
2. **æ‰©å±•æ§ä»¶åº“** - åŒ…å«æ–‡æœ¬ã€è¡¨å•ã€æ•°å€¼ã€åŠ¨æ€æ§ä»¶ç­‰
3. **é¢„è§ˆåŒºåŸŸ** - æ”¯æŒå®æ—¶é¢„è§ˆå’ŒåŠ¨æ€æ•°å€¼æ›´æ–°
4. **æ‹–æ‹½åŠŸèƒ½** - æ”¯æŒæ§ä»¶æ‹–æ‹½åˆ°é¢„è§ˆåŒºåŸŸ
5. **ä»£ç ç”Ÿæˆ** - ç”Ÿæˆå¸¦å ä½ç¬¦çš„åŠ¨æ€HTMLä»£ç 
6. **AIå›å¤è§£æ** - è§£æAIå›å¤ä¸­çš„æ•°å€¼å˜åŒ–æŒ‡ä»¤
7. **ä¸–ç•Œä¹¦é›†æˆ** - æ³¨å…¥æç¤ºè¯è®©AIè¾“å‡ºæ ‡å‡†åŒ–æŒ‡ä»¤
8. **åŠ¨æ€æ¸²æŸ“** - å®æ—¶æ›´æ–°ç•Œé¢æ•°å€¼æ˜¾ç¤º

### é«˜çº§åŠŸèƒ½
- **æ™ºèƒ½æ•°å€¼è§£æ** - è‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†AIå›å¤ä¸­çš„æ•°å€¼å˜åŒ–
- **åŠ¨æ€æ¨¡æ¿ç³»ç»Ÿ** - æ”¯æŒå˜é‡å ä½ç¬¦å’Œæ¡ä»¶æ¸²æŸ“
- **æç¤ºè¯å·¥ç¨‹** - å¼•å¯¼AIè¾“å‡ºæ ‡å‡†åŒ–çš„æ•°å€¼å˜åŒ–æŒ‡ä»¤
- **çŠ¶æ€æŒä¹…åŒ–** - ä¿å­˜å’Œæ¢å¤åŠ¨æ€æ•°å€¼çŠ¶æ€
- **å®æ—¶åŒæ­¥** - å¤šç•Œé¢é—´çš„æ•°å€¼çŠ¶æ€åŒæ­¥

## ç³»ç»Ÿæ¶æ„ - åŠ¨æ€æ•°å€¼ç³»ç»Ÿ

### æ‰©å±•æ¶æ„å±‚æ¬¡å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)"
        A[è§¦å‘æŒ‰é’®] --> B[è®¾è®¡å™¨æ¨¡æ€æ¡†]
        B --> C[æ‰©å±•æ§ä»¶åº“]
        B --> D[åŠ¨æ€é¢„è§ˆåŒºåŸŸ]
        B --> E[æ™ºèƒ½å·¥å…·æ ]
    end
    
    subgraph "AIé›†æˆå±‚ (AI Integration Layer)"
        F[AIå›å¤ç›‘å¬å™¨] --> G[æŒ‡ä»¤è§£æå™¨]
        G --> H[æ•°å€¼è®¡ç®—å™¨]
        H --> I[çŠ¶æ€æ›´æ–°å™¨]
    end
    
    subgraph "é€»è¾‘æ§åˆ¶å±‚ (Logic Layer)"
        J[æ‹–æ‹½ç®¡ç†å™¨] --> K[æ§ä»¶ç®¡ç†å™¨]
        K --> L[åŠ¨æ€ä»£ç ç”Ÿæˆå™¨]
        L --> M[æç¤ºè¯ç³»ç»Ÿ]
        M --> N[ä¸–ç•Œä¹¦é›†æˆå™¨]
    end
    
    subgraph "æ•°æ®å¤„ç†å±‚ (Data Layer)"
        O[åŠ¨æ€æ•°æ®ç®¡ç†] --> P[çŠ¶æ€å­˜å‚¨]
        Q[æ¨¡æ¿å¼•æ“] --> R[æ¸²æŸ“å¼•æ“]
    end
    
    subgraph "åŸºç¡€æ¡†æ¶å±‚ (Framework Layer)"
        S[SillyTavernæ‰©å±•ç³»ç»Ÿ] --> T[äº‹ä»¶ç³»ç»Ÿ]
        U[jQuery/jQuery UI] --> V[Bootstrap]
    end
    
    A --> J
    C --> K
    D --> R
    E --> M
    F --> O
    G --> Q
    H --> R
    I --> D
    J --> S
    K --> Q
    L --> P
    M --> S
    N --> S
    O --> T
    P --> U
    Q --> U
    R --> U
```

### åŠ¨æ€æ•°å€¼ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶

#### 1. æ‰©å±•æ§ä»¶åº“ (Extended Control Library)

```javascript
// æ‰©å±•æ§ä»¶å®šä¹‰
const ExtendedControls = {
    // æ–‡æœ¬æ§ä»¶
    text: {
        staticText: {
            name: 'é™æ€æ–‡æœ¬',
            template: '<span class="static-text">${text}</span>',
            properties: {
                text: { type: 'string', default: 'æ–‡æœ¬å†…å®¹' },
                fontSize: { type: 'number', default: 14 },
                color: { type: 'color', default: '#000000' }
            }
        },
        dynamicText: {
            name: 'åŠ¨æ€æ–‡æœ¬',
            template: '<span class="dynamic-text" data-field="${field}">${text}</span>',
            properties: {
                text: { type: 'string', default: 'åŠ¨æ€å†…å®¹' },
                field: { type: 'string', default: 'dynamic_field' },
                updateRule: { type: 'string', default: 'replace' }
            }
        },
        labelText: {
            name: 'æ ‡ç­¾æ–‡æœ¬',
            template: '<label class="label-text">${text}:</label>',
            properties: {
                text: { type: 'string', default: 'æ ‡ç­¾' },
                for: { type: 'string', default: '' }
            }
        }
    },
    
    // æ•°å€¼æ§ä»¶
    value: {
        numberInput: {
            name: 'æ•°å€¼è¾“å…¥æ¡†',
            template: '<input type="number" class="number-input" data-field="${field}" value="${value}" min="${min}" max="${max}" />',
            properties: {
                field: { type: 'string', default: 'number_field' },
                value: { type: 'number', default: 0 },
                min: { type: 'number', default: 0 },
                max: { type: 'number', default: 100 }
            }
        },
        numberDisplay: {
            name: 'æ•°å€¼æ˜¾ç¤º',
            template: '<span class="number-display" data-field="${field}">${value}</span>',
            properties: {
                field: { type: 'string', default: 'display_field' },
                value: { type: 'number', default: 0 },
                format: { type: 'string', default: '{value}' }
            }
        },
        progressBar: {
            name: 'è¿›åº¦æ¡',
            template: '<div class="progress"><div class="progress-bar" data-field="${field}" style="width: ${percentage}%">${value}/${max}</div></div>',
            properties: {
                field: { type: 'string', default: 'progress_field' },
                value: { type: 'number', default: 50 },
                max: { type: 'number', default: 100 },
                color: { type: 'color', default: '#007bff' }
            }
        }
    },
    
    // å¤åˆæ§ä»¶
    composite: {
        propertyGroup: {
            name: 'å±æ€§ç»„',
            template: '<div class="property-group"><h4>${title}</h4><div class="property-content">${content}</div></div>',
            properties: {
                title: { type: 'string', default: 'å±æ€§ç»„' },
                content: { type: 'html', default: '' }
            },
            allowChildren: true
        },
        statusPanel: {
            name: 'çŠ¶æ€é¢æ¿',
            template: '<div class="status-panel"><div class="status-header">${title}</div><div class="status-body">${content}</div></div>',
            properties: {
                title: { type: 'string', default: 'çŠ¶æ€é¢æ¿' },
                content: { type: 'html', default: '' }
            },
            allowChildren: true
        },
        valuePanel: {
            name: 'æ•°å€¼é¢æ¿',
            template: '<div class="value-panel"><div class="value-grid">${content}</div></div>',
            properties: {
                columns: { type: 'number', default: 2 },
                content: { type: 'html', default: '' }
            },
            allowChildren: true
        }
    }
};
```

#### 2. AIå›å¤è§£æç³»ç»Ÿ (AI Response Parser)

```javascript
class AIResponseParser {
    constructor() {
        this.commandPatterns = {
            // æ•°å€¼å˜åŒ–æŒ‡ä»¤æ¨¡å¼
            increase: /\+(\w+):([+-]?\d+)/g,          // +strength:5
            decrease: /\-(\w+):([+-]?\d+)/g,          // -health:10
            set: /=(\w+):(\d+)/g,                     // =level:15
            delete: /!(\w+)/g,                        // !temporary_buff
            // çŠ¶æ€å˜åŒ–æŒ‡ä»¤æ¨¡å¼
            enable: /\%enable:(\w+)/g,                // %enable:magic_shield
            disable: /\%disable:(\w+)/g,              // %disable:poison
            show: /\%show:(\w+)/g,                    // %show:hidden_stats
            hide: /\%hide:(\w+)/g                     // %hide:debug_info
        };
        
        this.hiddenCommandPattern = /<!--\s*STQSB:(.*?)\s*-->/g;
    }
    
    // è§£æAIå›å¤ä¸­çš„æŒ‡ä»¤
    parseResponse(responseText) {
        const commands = [];
        
        // æŸ¥æ‰¾éšè—æŒ‡ä»¤
        let match;
        while ((match = this.hiddenCommandPattern.exec(responseText)) !== null) {
            const commandString = match[1];
            const parsedCommands = this.parseCommandString(commandString);
            commands.push(...parsedCommands);
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°éšè—æŒ‡ä»¤ï¼Œå°è¯•è§£ææ˜¾å¼æŒ‡ä»¤
        if (commands.length === 0) {
            const explicitCommands = this.parseExplicitCommands(responseText);
            commands.push(...explicitCommands);
        }
        
        return commands;
    }
    
    // è§£ææŒ‡ä»¤å­—ç¬¦ä¸²
    parseCommandString(commandString) {
        const commands = [];
        
        Object.entries(this.commandPatterns).forEach(([type, pattern]) => {
            let match;
            while ((match = pattern.exec(commandString)) !== null) {
                const command = this.createCommand(type, match);
                if (command) {
                    commands.push(command);
                }
            }
        });
        
        return commands;
    }
    
    // åˆ›å»ºæŒ‡ä»¤å¯¹è±¡
    createCommand(type, match) {
        switch (type) {
            case 'increase':
            case 'decrease':
                return {
                    type: type,
                    field: match[1],
                    value: parseInt(match[2]),
                    timestamp: Date.now()
                };
            case 'set':
                return {
                    type: type,
                    field: match[1],
                    value: parseInt(match[2]),
                    timestamp: Date.now()
                };
            case 'delete':
                return {
                    type: type,
                    field: match[1],
                    timestamp: Date.now()
                };
            case 'enable':
            case 'disable':
            case 'show':
            case 'hide':
                return {
                    type: type,
                    field: match[1],
                    timestamp: Date.now()
                };
            default:
                return null;
        }
    }
    
    // æ‰§è¡ŒæŒ‡ä»¤
    executeCommands(commands) {
        const results = [];
        
        commands.forEach(command => {
            try {
                const result = this.executeCommand(command);
                results.push(result);
            } catch (error) {
                console.error('æ‰§è¡ŒæŒ‡ä»¤å¤±è´¥:', command, error);
                results.push({ success: false, error: error.message });
            }
        });
        
        return results;
    }
    
    // æ‰§è¡Œå•ä¸ªæŒ‡ä»¤
    executeCommand(command) {
        const currentState = this.getCurrentState();
        
        switch (command.type) {
            case 'increase':
                return this.updateValue(command.field, currentState[command.field] + command.value);
            case 'decrease':
                return this.updateValue(command.field, currentState[command.field] - command.value);
            case 'set':
                return this.updateValue(command.field, command.value);
            case 'delete':
                return this.deleteValue(command.field);
            case 'enable':
                return this.updateStatus(command.field, 'enabled');
            case 'disable':
                return this.updateStatus(command.field, 'disabled');
            case 'show':
                return this.updateVisibility(command.field, true);
            case 'hide':
                return this.updateVisibility(command.field, false);
            default:
                throw new Error(`æœªçŸ¥æŒ‡ä»¤ç±»å‹: ${command.type}`);
        }
    }
}
```

#### 3. åŠ¨æ€ä»£ç ç”Ÿæˆå™¨ (Dynamic Code Generator)

```javascript
class DynamicCodeGenerator extends CodeGenerator {
    // ç”Ÿæˆå¸¦å ä½ç¬¦çš„HTMLä»£ç 
    generateDynamicHTML(controls) {
        const html = this.buildDynamicHTMLStructure(controls);
        const css = this.generateDynamicCSS(controls);
        const js = this.generateDynamicJS(controls);
        
        return {
            html: this.formatHTML(html),
            css: this.formatCSS(css),
            js: this.formatJavaScript(js),
            template: this.generateTemplate(controls),
            complete: this.combineCode(html, css, js)
        };
    }
    
    // æ„å»ºåŠ¨æ€HTMLç»“æ„
    buildDynamicHTMLStructure(controls) {
        let html = '<div class="stqsb-dynamic-container">\n';
        
        controls.forEach(control => {
            html += this.generateDynamicControlHTML(control);
        });
        
        html += '</div>\n';
        return html;
    }
    
    // ç”ŸæˆåŠ¨æ€æ§ä»¶HTML
    generateDynamicControlHTML(control) {
        const template = this.getControlTemplate(control.type);
        let html = this.applyTemplate(template, control.properties);
        
        // æ·»åŠ åŠ¨æ€æ•°æ®å±æ€§
        if (control.properties.field) {
            html = html.replace(/(<[^>]+)/, `$1 data-field="${control.properties.field}"`);
        }
        
        // æ·»åŠ æ›´æ–°è§„åˆ™
        if (control.properties.updateRule) {
            html = html.replace(/(<[^>]+)/, `$1 data-update-rule="${control.properties.updateRule}"`);
        }
        
        return html;
    }
    
    // ç”Ÿæˆæ¨¡æ¿
    generateTemplate(controls) {
        const fields = this.extractFields(controls);
        const template = {
            html: this.buildDynamicHTMLStructure(controls),
            fields: fields,
            defaultValues: this.getDefaultValues(fields),
            updateRules: this.getUpdateRules(controls)
        };
        
        return template;
    }
    
    // æå–å­—æ®µä¿¡æ¯
    extractFields(controls) {
        const fields = {};
        
        controls.forEach(control => {
            if (control.properties.field) {
                fields[control.properties.field] = {
                    type: control.type,
                    defaultValue: control.properties.value || control.properties.text || '',
                    updateRule: control.properties.updateRule || 'replace',
                    min: control.properties.min,
                    max: control.properties.max
                };
            }
        });
        
        return fields;
    }
}
```

#### 4. æç¤ºè¯ç³»ç»Ÿ (Prompt System)

```javascript
class PromptSystem {
    constructor() {
        this.systemPrompts = {
            // åŸºç¡€ç³»ç»Ÿæç¤ºè¯
            base: `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œéœ€è¦åœ¨å›å¤ä¸­åŒ…å«çŠ¶æ€å˜åŒ–æŒ‡ä»¤ã€‚
æŒ‡ä»¤æ ¼å¼ï¼š
- å¢åŠ æ•°å€¼ï¼š+å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š+strength:5)
- å‡å°‘æ•°å€¼ï¼š-å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š-health:10)
- è®¾ç½®æ•°å€¼ï¼š=å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š=level:15)
- åˆ é™¤å­—æ®µï¼š!å­—æ®µå (ä¾‹å¦‚ï¼š!temporary_buff)
- å¯ç”¨çŠ¶æ€ï¼š%enable:å­—æ®µå (ä¾‹å¦‚ï¼š%enable:magic_shield)
- ç¦ç”¨çŠ¶æ€ï¼š%disable:å­—æ®µå (ä¾‹å¦‚ï¼š%disable:poison)

è¯·å°†è¿™äº›æŒ‡ä»¤æ”¾åœ¨HTMLæ³¨é‡Šä¸­ï¼š<!--STQSB:æŒ‡ä»¤åˆ—è¡¨-->`,
            
            // è§’è‰²æ‰®æ¼”æç¤ºè¯
            roleplay: `åœ¨è§’è‰²æ‰®æ¼”è¿‡ç¨‹ä¸­ï¼Œä½ éœ€è¦æ ¹æ®æƒ…å†µåŠ¨æ€è°ƒæ•´è§’è‰²çš„å±æ€§å’ŒçŠ¶æ€ã€‚
æ¯æ¬¡å›å¤æ—¶ï¼Œè¯·è¯„ä¼°ä»¥ä¸‹å› ç´ ï¼š
1. è§’è‰²çš„è¡Œä¸ºå’Œé€‰æ‹©å¯¹å±æ€§çš„å½±å“
2. ç¯å¢ƒå’Œäº‹ä»¶å¯¹çŠ¶æ€çš„æ”¹å˜
3. æŠ€èƒ½ä½¿ç”¨ã€æˆ˜æ–—ã€ä¼‘æ¯ç­‰æ´»åŠ¨çš„æ•ˆæœ
4. ç‰©å“ä½¿ç”¨ã€é­”æ³•æ•ˆæœã€çŠ¶æ€å¼‚å¸¸ç­‰çš„å½±å“

æ ¹æ®è¿™äº›å› ç´ ï¼Œåœ¨å›å¤æœ«å°¾çš„æ³¨é‡Šä¸­æ·»åŠ ç›¸åº”çš„çŠ¶æ€å˜åŒ–æŒ‡ä»¤ã€‚`,
            
            // æ•°å€¼å¹³è¡¡æç¤ºè¯
            balance: `è¯·éµå¾ªä»¥ä¸‹æ•°å€¼å¹³è¡¡åŸåˆ™ï¼š
1. å±æ€§å˜åŒ–åº”è¯¥åˆç†ï¼Œé¿å…è¿‡åº¦å¢å‡
2. é‡è¦å±æ€§ï¼ˆå¦‚ç”Ÿå‘½å€¼ï¼‰çš„å˜åŒ–åº”è¯¥æœ‰æ˜ç¡®çš„åŸå› 
3. æ­£é¢è¡Œä¸ºå¢åŠ æ­£é¢å±æ€§ï¼Œè´Ÿé¢è¡Œä¸ºå‡å°‘ç›¸å…³å±æ€§
4. è€ƒè™‘å±æ€§ä¹‹é—´çš„ç›¸äº’å…³ç³»å’Œåˆ¶çº¦
5. ä¿æŒæ¸¸æˆçš„æŒ‘æˆ˜æ€§å’Œè¶£å‘³æ€§`
        };
    }
    
    // ç”Ÿæˆå®Œæ•´çš„æç¤ºè¯
    generatePrompt(template, userFields) {
        const fieldDescriptions = this.generateFieldDescriptions(userFields);
        
        const prompt = `${this.systemPrompts.base}

${this.systemPrompts.roleplay}

${this.systemPrompts.balance}

å½“å‰è§’è‰²çŠ¶æ€å­—æ®µï¼š
${fieldDescriptions}

çŠ¶æ€æ˜¾ç¤ºæ¨¡æ¿ï¼š
${template.html}

è¯·åœ¨æ¯æ¬¡å›å¤æ—¶ï¼Œæ ¹æ®æƒ…å†µé€‚å½“è°ƒæ•´è¿™äº›å­—æ®µçš„å€¼ã€‚å°†å˜åŒ–æŒ‡ä»¤æ”¾åœ¨å›å¤æœ«å°¾çš„HTMLæ³¨é‡Šä¸­ã€‚
ç¤ºä¾‹ï¼š<!--STQSB:+strength:2,-fatigue:1,=mood:happy-->`;
        
        return prompt;
    }
    
    // ç”Ÿæˆå­—æ®µæè¿°
    generateFieldDescriptions(fields) {
        return Object.entries(fields).map(([name, field]) => {
            const description = `- ${name}: ${field.type}ç±»å‹ï¼Œé»˜è®¤å€¼${field.defaultValue}`;
            if (field.min !== undefined && field.max !== undefined) {
                return `${description}ï¼ŒèŒƒå›´${field.min}-${field.max}`;
            }
            return description;
        }).join('\n');
    }
    
    // ç”Ÿæˆä¸–ç•Œä¹¦æ¡ç›®
    generateWorldInfoEntry(template, fields) {
        const prompt = this.generatePrompt(template, fields);
        
        return {
            keys: ['status', 'stats', 'character_sheet'],
            content: `${prompt}

å½“å‰çŠ¶æ€æ˜¾ç¤ºï¼š
${template.html}`,
            constant: true,
            position: 'after_char',
            order: 50,
            extensions: {
                st_quick_status_bar: {
                    type: 'dynamic_status',
                    template: template,
                    fields: fields,
                    generated: true,
                    timestamp: Date.now()
                }
            }
        };
    }
}
```

#### 5. åŠ¨æ€æ¸²æŸ“å¼•æ“ (Dynamic Render Engine)

```javascript
class DynamicRenderEngine {
    constructor() {
        this.currentState = {};
        this.renderQueue = [];
        this.isRendering = false;
        this.observers = new Map();
    }
    
    // åˆå§‹åŒ–æ¸²æŸ“å¼•æ“
    init(container, template) {
        this.container = container;
        this.template = template;
        this.currentState = { ...template.defaultValues };
        this.renderInitialState();
        this.setupObservers();
    }
    
    // æ¸²æŸ“åˆå§‹çŠ¶æ€
    renderInitialState() {
        const html = this.processTemplate(this.template.html, this.currentState);
        this.container.innerHTML = html;
        this.bindElements();
    }
    
    // ç»‘å®šå…ƒç´ 
    bindElements() {
        const elements = this.container.querySelectorAll('[data-field]');
        
        elements.forEach(element => {
            const field = element.getAttribute('data-field');
            const updateRule = element.getAttribute('data-update-rule') || 'replace';
            
            // åˆ›å»ºè§‚å¯Ÿè€…
            this.observers.set(field, {
                element: element,
                updateRule: updateRule,
                originalValue: this.currentState[field]
            });
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.addEventListener('input', (e) => {
                    this.updateState(field, e.target.value);
                });
            }
        });
    }
    
    // æ›´æ–°çŠ¶æ€
    updateState(field, value, animated = true) {
        const oldValue = this.currentState[field];
        this.currentState[field] = value;
        
        // è§¦å‘å˜åŒ–äº‹ä»¶
        this.dispatchChangeEvent(field, oldValue, value);
        
        // æ›´æ–°å¯¹åº”çš„UIå…ƒç´ 
        this.updateElement(field, value, animated);
    }
    
    // æ›´æ–°å…ƒç´ 
    updateElement(field, value, animated = true) {
        const observer = this.observers.get(field);
        if (!observer) return;
        
        const { element, updateRule } = observer;
        
        if (animated) {
            this.animateValueChange(element, value, updateRule);
        } else {
            this.applyValueChange(element, value, updateRule);
        }
    }
    
    // åº”ç”¨æ•°å€¼å˜åŒ–
    applyValueChange(element, value, updateRule) {
        switch (updateRule) {
            case 'replace':
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.value = value;
                } else {
                    element.textContent = value;
                }
                break;
            case 'append':
                element.textContent += value;
                break;
            case 'prepend':
                element.textContent = value + element.textContent;
                break;
            case 'html':
                element.innerHTML = value;
                break;
            case 'progress':
                const percentage = (value / element.getAttribute('data-max')) * 100;
                element.style.width = `${percentage}%`;
                element.textContent = `${value}/${element.getAttribute('data-max')}`;
                break;
        }
    }
    
    // åŠ¨ç”»æ•ˆæœ
    animateValueChange(element, value, updateRule) {
        // æ·»åŠ å˜åŒ–åŠ¨ç”»ç±»
        element.classList.add('stqsb-changing');
        
        // å»¶è¿Ÿåº”ç”¨å˜åŒ–
        setTimeout(() => {
            this.applyValueChange(element, value, updateRule);
            
            // ç§»é™¤åŠ¨ç”»ç±»
            setTimeout(() => {
                element.classList.remove('stqsb-changing');
            }, 300);
        }, 100);
    }
    
    // æ‰¹é‡æ›´æ–°çŠ¶æ€
    batchUpdateState(updates) {
        updates.forEach(update => {
            this.updateState(update.field, update.value, false);
        });
        
        // è§¦å‘æ‰¹é‡æ¸²æŸ“
        this.renderBatch();
    }
    
    // å¤„ç†AIæŒ‡ä»¤
    processAICommands(commands) {
        const updates = [];
        
        commands.forEach(command => {
            const currentValue = this.currentState[command.field] || 0;
            let newValue;
            
            switch (command.type) {
                case 'increase':
                    newValue = currentValue + command.value;
                    break;
                case 'decrease':
                    newValue = currentValue - command.value;
                    break;
                case 'set':
                    newValue = command.value;
                    break;
                case 'delete':
                    newValue = null;
                    break;
                default:
                    continue;
            }
            
            // è¾¹ç•Œæ£€æŸ¥
            const fieldConfig = this.template.fields[command.field];
            if (fieldConfig) {
                if (fieldConfig.min !== undefined && newValue < fieldConfig.min) {
                    newValue = fieldConfig.min;
                }
                if (fieldConfig.max !== undefined && newValue > fieldConfig.max) {
                    newValue = fieldConfig.max;
                }
            }
            
            updates.push({
                field: command.field,
                value: newValue,
                command: command
            });
        });
        
        this.batchUpdateState(updates);
    }
    
    // å¯¼å‡ºçŠ¶æ€
    exportState() {
        return {
            currentState: { ...this.currentState },
            timestamp: Date.now()
        };
    }
    
    // å¯¼å…¥çŠ¶æ€
    importState(state) {
        this.currentState = { ...state.currentState };
        this.renderInitialState();
    }
}
```

## ä¸–ç•Œä¹¦é›†æˆå¢å¼ºè®¾è®¡

### ä¸–ç•Œä¹¦æ¡ç›®ç”Ÿæˆç­–ç•¥

#### 1. ä¸–ç•Œä¹¦æ¡ç›®ç»“æ„è®¾è®¡

```javascript
// åŠ¨æ€çŠ¶æ€ä¸–ç•Œä¹¦æ¡ç›®
const DynamicStatusWorldInfoEntry = {
    // åŸºç¡€ä¿¡æ¯
    uid: 'stqsb-dynamic-status-' + Date.now(),
    key: ['status', 'stats', 'character_sheet', 'attributes'],
    keysecondary: ['health', 'mana', 'strength', 'level'],
    
    // ä¸–ç•Œä¹¦å†…å®¹ - åŒ…å«æç¤ºè¯å’ŒHTMLæ¨¡æ¿
    content: `${promptSystem.generatePrompt(template, fields)}

å½“å‰çŠ¶æ€æ˜¾ç¤ºï¼š
${template.html}

è¯·åœ¨æ¯æ¬¡å›å¤æ—¶ï¼Œæ ¹æ®æƒ…å†µå˜åŒ–åœ¨å›å¤æœ«å°¾æ·»åŠ çŠ¶æ€å˜åŒ–æŒ‡ä»¤ã€‚
æŒ‡ä»¤æ ¼å¼ï¼š<!--STQSB:+strength:2,-health:5,=level:10-->`,
    
    // è§¦å‘é…ç½®
    constant: true,                    // æ°¸ä¹…æ¿€æ´»
    selective: false,                  // ä¸ä½¿ç”¨å…³é”®è¯è§¦å‘
    probability: 100,                  // 100%è§¦å‘æ¦‚ç‡
    position: 'after_char',            // åœ¨è§’è‰²æè¿°åæ’å…¥
    order: 50,                         // æ’å…¥é¡ºåº
    depth: 1,                          // æ·±åº¦è®¾ç½®
    
    // æ‰©å±•ä¿¡æ¯
    extensions: {
        st_quick_status_bar: {
            type: 'dynamic_status',
            version: '1.0.0',
            template: template,
            fields: fields,
            generated: true,
            timestamp: Date.now(),
            config: {
                updateOnMessage: true,
                showInChat: true,
                persistState: true
            }
        }
    },
    
    // çŠ¶æ€æ§åˆ¶
    enabled: true,
    comment: 'ç”±STQuickStatusBarç”Ÿæˆçš„åŠ¨æ€çŠ¶æ€ç³»ç»Ÿ'
};
```

#### 2. ä¸–ç•Œä¹¦é›†æˆå·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Designer as è®¾è®¡å™¨
    participant WorldInfo as ä¸–ç•Œä¹¦ç³»ç»Ÿ
    participant AI as AIåŠ©æ‰‹
    participant Parser as è§£æå™¨
    participant Renderer as æ¸²æŸ“å™¨
    
    User->>Designer: è®¾è®¡çŠ¶æ€ç•Œé¢
    Designer->>Designer: ç”ŸæˆHTMLæ¨¡æ¿
    User->>Designer: ç‚¹å‡»"æ’å…¥ä¸–ç•Œä¹¦"
    Designer->>WorldInfo: åˆ›å»ºåŠ¨æ€çŠ¶æ€æ¡ç›®
    WorldInfo->>AI: æ³¨å…¥æç¤ºè¯å’Œæ¨¡æ¿
    
    loop æ¯æ¬¡å¯¹è¯
        AI->>AI: ç”Ÿæˆå›å¤å†…å®¹
        AI->>AI: æ ¹æ®æƒ…å†µæ·»åŠ çŠ¶æ€æŒ‡ä»¤
        AI->>User: å‘é€å›å¤ï¼ˆå«éšè—æŒ‡ä»¤ï¼‰
        Parser->>Parser: è§£æAIå›å¤ä¸­çš„æŒ‡ä»¤
        Parser->>Renderer: æ‰§è¡Œæ•°å€¼å˜åŒ–
        Renderer->>User: æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    end
```

#### 3. æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ

```javascript
// æç¤ºè¯æ¨¡æ¿é…ç½®
const PromptTemplates = {
    // åŸºç¡€è§’è‰²æ‰®æ¼”æ¨¡æ¿
    roleplay: {
        name: 'è§’è‰²æ‰®æ¼”æ¨¡æ¿',
        template: `ä½ æ­£åœ¨æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œéœ€è¦æ ¹æ®å¯¹è¯å†…å®¹åŠ¨æ€æ›´æ–°è§’è‰²çŠ¶æ€ã€‚

è§’è‰²çŠ¶æ€å­—æ®µï¼š
{{fieldDescriptions}}

æ›´æ–°è§„åˆ™ï¼š
1. æ ¹æ®è§’è‰²è¡Œä¸ºå’Œé€‰æ‹©è°ƒæ•´å±æ€§
2. æˆ˜æ–—ã€æŠ€èƒ½ä½¿ç”¨ã€ä¼‘æ¯ç­‰æ´»åŠ¨å½±å“æ•°å€¼
3. ç‰©å“ä½¿ç”¨ã€é­”æ³•æ•ˆæœäº§ç”Ÿä¸´æ—¶æˆ–æ°¸ä¹…å˜åŒ–
4. ç¯å¢ƒå› ç´ å¯èƒ½å½±å“æŸäº›å±æ€§

è¯·åœ¨æ¯æ¬¡å›å¤æœ«å°¾æ·»åŠ çŠ¶æ€å˜åŒ–æŒ‡ä»¤ï¼š<!--STQSB:æŒ‡ä»¤åˆ—è¡¨-->

å½“å‰çŠ¶æ€æ˜¾ç¤ºï¼š
{{statusTemplate}}`,
        fields: ['health', 'mana', 'strength', 'level', 'experience']
    },
    
    // æ¸¸æˆç³»ç»Ÿæ¨¡æ¿
    gaming: {
        name: 'æ¸¸æˆç³»ç»Ÿæ¨¡æ¿',
        template: `ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸»æŒäººï¼Œéœ€è¦ç®¡ç†ç©å®¶è§’è‰²çš„å„é¡¹æ•°å€¼ã€‚

æ•°å€¼ç®¡ç†è§„åˆ™ï¼š
1. ç”Ÿå‘½å€¼èŒƒå›´ï¼š0-100ï¼Œå½’é›¶æ—¶è§’è‰²æ­»äº¡
2. æ³•åŠ›å€¼èŒƒå›´ï¼š0-100ï¼Œå½±å“é­”æ³•ä½¿ç”¨
3. åŠ›é‡å½±å“ç‰©ç†æ”»å‡»åŠ›å’Œè´Ÿé‡
4. æ•æ·å½±å“é€Ÿåº¦å’Œå‘½ä¸­ç‡
5. æ™ºåŠ›å½±å“æ³•æœ¯å¨åŠ›å’Œæ³•åŠ›æ¢å¤

ç»éªŒå€¼è·å¾—ï¼š
- å‡»è´¥æ•Œäººï¼š+10-50ç»éªŒ
- å®Œæˆä»»åŠ¡ï¼š+20-100ç»éªŒ
- æ¢ç´¢å‘ç°ï¼š+5-20ç»éªŒ
- æ¯100ç»éªŒå‡çº§ä¸€æ¬¡

è¯·æ ¹æ®ç©å®¶è¡Œä¸ºåˆç†è°ƒæ•´æ•°å€¼ï¼š<!--STQSB:æŒ‡ä»¤åˆ—è¡¨-->

{{statusTemplate}}`,
        fields: ['health', 'mana', 'strength', 'agility', 'intelligence', 'level', 'experience']
    },
    
    // ç”Ÿå­˜æ¨¡æ‹Ÿæ¨¡æ¿
    survival: {
        name: 'ç”Ÿå­˜æ¨¡æ‹Ÿæ¨¡æ¿',
        template: `ä½ æ­£åœ¨ä¸»æŒä¸€ä¸ªç”Ÿå­˜æ¨¡æ‹Ÿæ¸¸æˆï¼Œéœ€è¦ç®¡ç†è§’è‰²çš„ç”Ÿå­˜çŠ¶æ€ã€‚

ç”Ÿå­˜è¦ç´ ï¼š
1. ç”Ÿå‘½å€¼ï¼šå—ä¼¤ã€ç–¾ç—…ã€é¥¥é¥¿å½±å“
2. é¥¥é¥¿åº¦ï¼š0-100ï¼Œä½äº20æ—¶å½±å“è¡ŒåŠ¨
3. å£æ¸´åº¦ï¼š0-100ï¼Œä½äº10æ—¶å¿«é€ŸæŸå¤±ç”Ÿå‘½
4. ç–²åŠ³åº¦ï¼š0-100ï¼Œå½±å“è¡ŒåŠ¨æ•ˆç‡
5. ä½“æ¸©ï¼šé€‚å®œèŒƒå›´36-38åº¦
6. å£«æ°”ï¼šå¿ƒç†çŠ¶æ€ï¼Œå½±å“åˆ¤æ–­åŠ›

ç¯å¢ƒå½±å“ï¼š
- æ¶åŠ£å¤©æ°”å¢åŠ ç–²åŠ³å’Œä½“æ¸©å˜åŒ–
- é£Ÿç‰©ç¨€ç¼ºå¢åŠ é¥¥é¥¿åº¦
- å±é™©ç¯å¢ƒé™ä½å£«æ°”
- ä¼‘æ¯å’Œå®‰å…¨ç¯å¢ƒæ¢å¤çŠ¶æ€

è¯·æ ¹æ®æƒ…å†µæ›´æ–°ç”Ÿå­˜çŠ¶æ€ï¼š<!--STQSB:æŒ‡ä»¤åˆ—è¡¨-->

{{statusTemplate}}`,
        fields: ['health', 'hunger', 'thirst', 'fatigue', 'temperature', 'morale']
    }
};
```

#### 4. æ™ºèƒ½æ•°å€¼å˜åŒ–ç³»ç»Ÿ

```javascript
class IntelligentValueSystem {
    constructor() {
        this.changeRules = {
            // æˆ˜æ–—ç›¸å…³è§„åˆ™
            combat: {
                patterns: [
                    { trigger: /æ”»å‡»|æˆ˜æ–—|æ‰“å‡»/, effect: '+fatigue:5,-mana:10' },
                    { trigger: /å—ä¼¤|å—åˆ°ä¼¤å®³/, effect: '-health:15,+pain:10' },
                    { trigger: /å‡»è´¥|èƒœåˆ©/, effect: '+experience:20,+confidence:5' },
                    { trigger: /å¤±è´¥|è´¥åŒ—/, effect: '-confidence:5,+fatigue:10' }
                ]
            },
            
            // æŠ€èƒ½ä½¿ç”¨è§„åˆ™
            skills: {
                patterns: [
                    { trigger: /ä½¿ç”¨é­”æ³•|æ–½æ³•/, effect: '-mana:15,+experience:2' },
                    { trigger: /å·çªƒ|æ½œè¡Œ/, effect: '+stealth_exp:5,-energy:5' },
                    { trigger: /æ²»ç–—|æ¢å¤/, effect: '+health:20,-mana:25' },
                    { trigger: /å†¥æƒ³|ä¼‘æ¯/, effect: '+mana:15,-fatigue:10' }
                ]
            },
            
            // ç¯å¢ƒå½±å“è§„åˆ™
            environment: {
                patterns: [
                    { trigger: /å¯’å†·|å†°å†»/, effect: '-temperature:5,+fatigue:3' },
                    { trigger: /ç‚çƒ­|é…·çƒ­/, effect: '+temperature:5,+thirst:10' },
                    { trigger: /ä¸‹é›¨|æ½®æ¹¿/, effect: '-temperature:2,+discomfort:5' },
                    { trigger: /é˜³å…‰|æ¸©æš–/, effect: '+mood:3,+energy:5' }
                ]
            },
            
            // ç¤¾äº¤äº’åŠ¨è§„åˆ™
            social: {
                patterns: [
                    { trigger: /æˆåŠŸè¯´æœ|äº¤æ¶‰æˆåŠŸ/, effect: '+charisma:2,+confidence:5' },
                    { trigger: /è¢«æ‹’ç»|äº¤æ¶‰å¤±è´¥/, effect: '-confidence:3,+frustration:5' },
                    { trigger: /è·å¾—å¸®åŠ©|ç»“äº¤æœ‹å‹/, effect: '+mood:10,+social_standing:5' },
                    { trigger: /è¢«èƒŒå›|å—åˆ°æ¬ºéª—/, effect: '-trust:10,-mood:15' }
                ]
            }
        };
    }
    
    // æ™ºèƒ½åˆ†æAIå›å¤å¹¶ç”ŸæˆæŒ‡ä»¤
    analyzeAndGenerateCommands(aiResponse) {
        const commands = [];
        
        // éå†æ‰€æœ‰è§„åˆ™ç±»åˆ«
        Object.values(this.changeRules).forEach(category => {
            category.patterns.forEach(rule => {
                if (rule.trigger.test(aiResponse)) {
                    const generatedCommands = this.parseEffectString(rule.effect);
                    commands.push(...generatedCommands);
                }
            });
        });
        
        return commands;
    }
    
    // è§£ææ•ˆæœå­—ç¬¦ä¸²
    parseEffectString(effectString) {
        const commands = [];
        const effects = effectString.split(',');
        
        effects.forEach(effect => {
            const match = effect.match(/([+\-=])(\w+):([+-]?\d+)/);
            if (match) {
                const [, operator, field, value] = match;
                commands.push({
                    type: operator === '+' ? 'increase' : 
                          operator === '-' ? 'decrease' : 'set',
                    field: field,
                    value: parseInt(value)
                });
            }
        });
        
        return commands;
    }
}
```

#### 5. å®æ—¶çŠ¶æ€æ˜¾ç¤ºç³»ç»Ÿ

```javascript
class RealTimeStatusDisplay {
    constructor() {
        this.statusContainer = null;
        this.isVisible = false;
        this.currentTemplate = null;
        this.updateInterval = null;
    }
    
    // åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºç•Œé¢
    createStatusDisplay(template) {
        this.currentTemplate = template;
        
        // åˆ›å»ºçŠ¶æ€å®¹å™¨
        this.statusContainer = document.createElement('div');
        this.statusContainer.className = 'stqsb-status-display';
        this.statusContainer.innerHTML = `
            <div class="stqsb-status-header">
                <span class="stqsb-status-title">è§’è‰²çŠ¶æ€</span>
                <button class="stqsb-toggle-btn" onclick="this.toggleVisibility()">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="stqsb-status-content">
                ${template.html}
            </div>
        `;
        
        // æ’å…¥åˆ°èŠå¤©ç•Œé¢
        const chatContainer = document.getElementById('chat');
        if (chatContainer) {
            chatContainer.insertBefore(this.statusContainer, chatContainer.firstChild);
        }
        
        // åˆå§‹åŒ–æ¸²æŸ“å¼•æ“
        this.renderEngine = new DynamicRenderEngine();
        this.renderEngine.init(
            this.statusContainer.querySelector('.stqsb-status-content'),
            template
        );
        
        // å¼€å§‹ç›‘å¬AIå›å¤
        this.startAIResponseListener();
    }
    
    // å¼€å§‹ç›‘å¬AIå›å¤
    startAIResponseListener() {
        // ç›‘å¬SillyTavernçš„æ¶ˆæ¯æ¥æ”¶äº‹ä»¶
        eventSource.on(event_types.MESSAGE_RECEIVED, (messageId) => {
            const message = chat[messageId];
            if (message && !message.is_user) {
                this.processAIMessage(message.mes);
            }
        });
    }
    
    // å¤„ç†AIæ¶ˆæ¯
    processAIMessage(messageContent) {
        // è§£æAIå›å¤ä¸­çš„æŒ‡ä»¤
        const parser = new AIResponseParser();
        const commands = parser.parseResponse(messageContent);
        
        if (commands.length > 0) {
            // æ‰§è¡ŒæŒ‡ä»¤æ›´æ–°çŠ¶æ€
            this.renderEngine.processAICommands(commands);
            
            // æ˜¾ç¤ºå˜åŒ–åŠ¨ç”»
            this.showChangeAnimation(commands);
            
            // ä¿å­˜çŠ¶æ€
            this.saveCurrentState();
        }
    }
    
    // æ˜¾ç¤ºå˜åŒ–åŠ¨ç”»
    showChangeAnimation(commands) {
        commands.forEach(command => {
            const element = this.statusContainer.querySelector(`[data-field="${command.field}"]`);
            if (element) {
                // åˆ›å»ºå˜åŒ–æç¤º
                const changeIndicator = document.createElement('div');
                changeIndicator.className = 'stqsb-change-indicator';
                changeIndicator.textContent = `${command.type === 'increase' ? '+' : '-'}${Math.abs(command.value)}`;
                
                // å®šä½åˆ°å…ƒç´ æ—è¾¹
                const rect = element.getBoundingClientRect();
                changeIndicator.style.position = 'fixed';
                changeIndicator.style.left = `${rect.right + 10}px`;
                changeIndicator.style.top = `${rect.top}px`;
                changeIndicator.style.zIndex = '9999';
                
                document.body.appendChild(changeIndicator);
                
                // åŠ¨ç”»æ•ˆæœ
                setTimeout(() => {
                    changeIndicator.style.opacity = '0';
                    changeIndicator.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        document.body.removeChild(changeIndicator);
                    }, 300);
                }, 1000);
            }
        });
    }
    
    // ä¿å­˜å½“å‰çŠ¶æ€
    saveCurrentState() {
        const state = this.renderEngine.exportState();
        const characterId = this_chid;
        
        // ä¿å­˜åˆ°è§’è‰²æ•°æ®
        if (characters[characterId]) {
            if (!characters[characterId].data) {
                characters[characterId].data = {};
            }
            if (!characters[characterId].data.extensions) {
                characters[characterId].data.extensions = {};
            }
            
            characters[characterId].data.extensions.st_quick_status_bar = {
                state: state,
                template: this.currentTemplate,
                lastUpdated: Date.now()
            };
            
            // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
            fetch('/api/characters/merge-attributes', {
                method: 'POST',
                headers: getRequestHeaders(),
                body: JSON.stringify({
                    avatar: characters[characterId].avatar,
                    data: {
                        extensions: {
                            st_quick_status_bar: characters[characterId].data.extensions.st_quick_status_bar
                        }
                    }
                })
            });
        }
    }
    
    // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
    toggleVisibility() {
        this.isVisible = !this.isVisible;
        const content = this.statusContainer.querySelector('.stqsb-status-content');
        const toggleBtn = this.statusContainer.querySelector('.stqsb-toggle-btn i');
        
        if (this.isVisible) {
            content.style.display = 'block';
            toggleBtn.className = 'fas fa-chevron-up';
        } else {
            content.style.display = 'none';
            toggleBtn.className = 'fas fa-chevron-down';
        }
    }
}
```

### å®Œæ•´ä½¿ç”¨æµç¨‹ç¤ºä¾‹

#### ç¤ºä¾‹1: è§’è‰²æ‰®æ¼”æ¸¸æˆçŠ¶æ€é¢æ¿

1. **è®¾è®¡é˜¶æ®µ**ï¼š
   - æ‹–æ‹½"æ ‡ç­¾æ–‡æœ¬"æ§ä»¶ï¼Œè®¾ç½®æ–‡æœ¬ä¸º"äººç‰©"
   - æ‹–æ‹½"æ–‡æœ¬è¾“å…¥æ¡†"æ§ä»¶ï¼Œè®¾ç½®fieldä¸º"character_name"
   - æ‹–æ‹½"æ ‡ç­¾æ–‡æœ¬"æ§ä»¶ï¼Œè®¾ç½®æ–‡æœ¬ä¸º"åŠ›é‡"
   - æ‹–æ‹½"æ•°å€¼æ˜¾ç¤º"æ§ä»¶ï¼Œè®¾ç½®fieldä¸º"strength"ï¼Œé»˜è®¤å€¼ä¸º10
   - æ‹–æ‹½"æ ‡ç­¾æ–‡æœ¬"æ§ä»¶ï¼Œè®¾ç½®æ–‡æœ¬ä¸º"ç”Ÿå‘½å€¼"
   - æ‹–æ‹½"è¿›åº¦æ¡"æ§ä»¶ï¼Œè®¾ç½®fieldä¸º"health"ï¼Œæœ€å¤§å€¼ä¸º100

2. **ç”Ÿæˆçš„HTMLæ¨¡æ¿**ï¼š
```html
<div class="stqsb-dynamic-container">
    <label class="label-text">äººç‰©:</label>
    <input type="text" class="text-input" data-field="character_name" value="è§’è‰²åå­—" />
    <label class="label-text">åŠ›é‡:</label>
    <span class="number-display" data-field="strength">10</span>
    <label class="label-text">ç”Ÿå‘½å€¼:</label>
    <div class="progress">
        <div class="progress-bar" data-field="health" style="width: 100%">100/100</div>
    </div>
</div>
```

3. **ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹**ï¼š
```
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œéœ€è¦åœ¨å›å¤ä¸­åŒ…å«çŠ¶æ€å˜åŒ–æŒ‡ä»¤ã€‚
æŒ‡ä»¤æ ¼å¼ï¼š
- å¢åŠ æ•°å€¼ï¼š+å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š+strength:5)
- å‡å°‘æ•°å€¼ï¼š-å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š-health:10)
- è®¾ç½®æ•°å€¼ï¼š=å­—æ®µå:æ•°å€¼ (ä¾‹å¦‚ï¼š=level:15)

å½“å‰è§’è‰²çŠ¶æ€å­—æ®µï¼š
- character_name: stringç±»å‹ï¼Œé»˜è®¤å€¼"è§’è‰²åå­—"
- strength: numberç±»å‹ï¼Œé»˜è®¤å€¼10ï¼ŒèŒƒå›´0-20
- health: numberç±»å‹ï¼Œé»˜è®¤å€¼100ï¼ŒèŒƒå›´0-100

è¯·åœ¨æ¯æ¬¡å›å¤æ—¶ï¼Œæ ¹æ®æƒ…å†µé€‚å½“è°ƒæ•´è¿™äº›å­—æ®µçš„å€¼ã€‚å°†å˜åŒ–æŒ‡ä»¤æ”¾åœ¨å›å¤æœ«å°¾çš„HTMLæ³¨é‡Šä¸­ã€‚
ç¤ºä¾‹ï¼š<!--STQSB:+strength:2,-health:15-->

å½“å‰çŠ¶æ€æ˜¾ç¤ºï¼š
<div class="stqsb-dynamic-container">
    <label class="label-text">äººç‰©:</label>
    <input type="text" class="text-input" data-field="character_name" value="è§’è‰²åå­—" />
    <label class="label-text">åŠ›é‡:</label>
    <span class="number-display" data-field="strength">10</span>
    <label class="label-text">ç”Ÿå‘½å€¼:</label>
    <div class="progress">
        <div class="progress-bar" data-field="health" style="width: 100%">100/100</div>
    </div>
</div>
```

4. **AIå›å¤ç¤ºä¾‹**ï¼š
```
ä½ å†³å®šä¸¾èµ·è¿™å—å·¨å¤§çš„çŸ³å¤´ï¼Œè™½ç„¶å¾ˆé‡ï¼Œä½†æ˜¯é€šè¿‡åŠªåŠ›ï¼Œä½ æˆåŠŸåœ°å°†å®ƒä¸¾è¿‡å¤´é¡¶ã€‚è¿™æ¬¡è®­ç»ƒè®©ä½ æ„Ÿåˆ°è‚Œè‚‰å˜å¾—æ›´åŠ å¼ºå£®ï¼Œä½†ä¹Ÿæ¶ˆè€—äº†ä¸€äº›ä½“åŠ›ã€‚

<!--STQSB:+strength:2,-health:5-->
```

5. **ç³»ç»Ÿè‡ªåŠ¨å¤„ç†**ï¼š
   - è§£æå™¨è¯†åˆ«æŒ‡ä»¤ï¼š`+strength:2,-health:5`
   - æ‰§è¡Œæ•°å€¼å˜åŒ–ï¼šåŠ›é‡ä»10å¢åŠ åˆ°12ï¼Œç”Ÿå‘½å€¼ä»100å‡å°‘åˆ°95
   - æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼šåŠ›é‡æ˜¾ç¤ºæ›´æ–°ä¸º12ï¼Œç”Ÿå‘½å€¼è¿›åº¦æ¡æ›´æ–°ä¸º95%
   - æ˜¾ç¤ºå˜åŒ–åŠ¨ç”»ï¼šåŠ›é‡æ—è¾¹æ˜¾ç¤º"+2"ï¼Œç”Ÿå‘½å€¼æ—è¾¹æ˜¾ç¤º"-5"

## æŠ€æœ¯å®ç°ç»†èŠ‚

### CSSåŠ¨ç”»æ ·å¼

```css
/* çŠ¶æ€æ˜¾ç¤ºå®¹å™¨ */
.stqsb-status-display {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 300px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    color: white;
    font-family: Arial, sans-serif;
    z-index: 1000;
    transition: all 0.3s ease;
}

/* çŠ¶æ€æ ‡é¢˜æ  */
.stqsb-status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px 10px 0 0;
    cursor: pointer;
}

/* çŠ¶æ€å†…å®¹åŒºåŸŸ */
.stqsb-status-content {
    padding: 15px;
    max-height: 400px;
    overflow-y: auto;
}

/* æ•°å€¼å˜åŒ–åŠ¨ç”» */
.stqsb-changing {
    animation: valueChange 0.5s ease-in-out;
    color: #ffd700;
}

@keyframes valueChange {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* å˜åŒ–æŒ‡ç¤ºå™¨ */
.stqsb-change-indicator {
    position: fixed;
    background: #28a745;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    pointer-events: none;
}

/* è¿›åº¦æ¡æ ·å¼ */
.stqsb-dynamic-container .progress {
    width: 100%;
    height: 20px;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
}

.stqsb-dynamic-container .progress-bar {
    height: 100%;
    background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* æ•°å€¼æ˜¾ç¤ºæ ·å¼ */
.stqsb-dynamic-container .number-display {
    display: inline-block;
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 10px;
    border-radius: 5px;
    margin: 0 5px;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

/* æ ‡ç­¾æ ·å¼ */
.stqsb-dynamic-container .label-text {
    display: inline-block;
    margin-right: 10px;
    font-weight: bold;
    color: #ccc;
}
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹é‡æ›´æ–°**ï¼šæ”¶é›†å¤šä¸ªæ•°å€¼å˜åŒ–åæ‰¹é‡æ‰§è¡ŒDOMæ›´æ–°
2. **é˜²æŠ–å¤„ç†**ï¼šé¿å…é¢‘ç¹çš„çŠ¶æ€ä¿å­˜æ“ä½œ
3. **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†ä¸å†ä½¿ç”¨çš„äº‹ä»¶ç›‘å¬å™¨
4. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜æ¨¡æ¿ç¼–è¯‘ç»“æœå’Œæ­£åˆ™è¡¨è¾¾å¼
5. **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½å¤æ‚çš„åŠ¨ç”»æ•ˆæœ

è¿™ä¸ªå¢å¼ºçš„æ¶æ„è®¾è®¡å®ç°äº†æ‚¨è¦æ±‚çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- å®Œæ•´çš„æ§ä»¶åº“ï¼ˆåŒ…å«æ–‡æœ¬æ§ä»¶ï¼‰
- AIå›å¤è§£æå’Œæ•°å€¼å˜åŒ–ç³»ç»Ÿ
- æ™ºèƒ½æç¤ºè¯ç”Ÿæˆ
- å®æ—¶çŠ¶æ€æ˜¾ç¤ºå’ŒåŠ¨ç”»æ•ˆæœ
- ä¸–ç•Œä¹¦æ·±åº¦é›†æˆ

ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®AIçš„å›å¤è‡ªåŠ¨è°ƒæ•´ç•Œé¢ä¸­çš„æ•°å€¼ï¼Œåˆ›å»ºçœŸæ­£çš„äº¤äº’å¼è§’è‰²çŠ¶æ€é¢æ¿ã€‚