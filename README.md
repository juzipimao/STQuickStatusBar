# ST快速状态栏扩展 (STQuickStatusBar)

[![版本](https://img.shields.io/badge/版本-1.0.0-blue.svg)](https://github.com/your-repo/STQuickStatusBar)
[![许可证](https://img.shields.io/badge/许可证-自定义限制性-red.svg)](#许可证声明)
[![SillyTavern](https://img.shields.io/badge/SillyTavern-兼容-green.svg)](https://github.com/SillyTavern/SillyTavern)

## 🎯 简介

ST快速状态栏扩展是专为SillyTavern设计的高级正则表达式工具，旨在简化角色状态栏的创建和管理。通过直观的模态框界面和强大的AI生成功能，让用户能够快速为当前角色添加个性化的状态栏显示规则。

## ✨ 核心功能

### 🔧 手动创建模式
- **可视化正则编辑器**：提供友好的表单界面，无需深入了解正则表达式语法
- **实时验证与预览**：输入时即时验证正则表达式的有效性，并提供测试预览功能
- **多行内容支持**：完全保留用户输入格式，支持复杂的多行正则表达式
- **影响范围控制**：精确控制正则规则作用于用户输入、AI输出或全部内容
- **智能记忆功能**：自动记住上次的输入内容，提升使用效率

### 🤖 AI智能生成
- **多API支持**：
  - **Gemini API**：支持Google Gemini 2.5 Pro模型，提供强大的正则生成能力
  - **自定义OpenAI格式API**：兼容各种OpenAI格式的第三方API服务
- **专业提示工程**：内置专门优化的提示词，确保生成高质量的状态栏正则规则
- **智能内容分析**：自动分析用户需求，生成包含正则表达式、XML格式、示例内容和HTML美化的完整方案
- **对话历史管理**：
  - 支持多轮对话，每次打开工具自动恢复上次对话内容
  - 智能历史存储，最多保存10条历史对话记录
  - 静默后台处理，用户无感的上下文管理

### 💾 配置管理
- **自动保存机制**：
  - API配置实时保存到浏览器本地存储
  - 三层保存架构：localStorage临时缓存 → 内存状态 → SillyTavern全局设置
  - 页面刷新后自动恢复所有配置
- **可视化状态反馈**：实时显示保存状态，"✓ 已保存"或"✗ 保存失败"提示

### 🎨 代码优化
- **智能代码包裹**：点击"应用到手动创建页面"时，自动为替换内容添加markdown代码块包裹
- **内容类型检测**：
  - HTML内容：添加```html包裹
  - 结构化内容：添加```包裹
  - 防重复处理：已有包裹的内容保持原样

### 🖥️ 用户界面
- **现代化设计**：采用渐变背景、玻璃形态效果的现代UI设计
- **响应式布局**：完美适配桌面端和移动端设备
- **主题适配**：自动适配SillyTavern的明暗主题切换
- **流畅动画**：优雅的页面切换和状态变化动画效果

## 🚀 快速开始

### 安装方式

#### 方式一：GitHub扩展安装（推荐）
1. **打开SillyTavern扩展管理**：进入SillyTavern的扩展设置页面
2. **添加扩展仓库**：在扩展管理中点击"安装扩展"
3. **输入仓库地址**：
   ```
   https://github.com/juzipimao/STQuickStatusBar
   ```
4. **自动安装**：SillyTavern会自动下载并安装扩展
5. **启用扩展**：安装完成后启用"ST快速状态栏"扩展

#### 方式二：手动复制安装
1. **下载源码**：从GitHub仓库下载最新版本
2. **复制文件**：将整个`STQuickStatusBar`文件夹复制到SillyTavern的扩展目录：
   ```
   SillyTavern/data/default-user/extensions/STQuickStatusBar/
   ```
3. **重启SillyTavern**：重新启动SillyTavern以加载扩展
4. **启用扩展**：在SillyTavern的扩展设置中找到"ST快速状态栏"并启用

### 基本使用

#### 方式一：通过设置面板
1. 进入SillyTavern的扩展设置页面
2. 找到"ST快速状态栏"扩展设置
3. 点击"打开快速正则工具"按钮

#### 方式二：通过斜杠命令
在聊天框中输入：`/st-status-bar`

#### 方式三：通过全局快捷方式
扩展会自动注册全局访问方式（如果支持）

## 📋 使用指南

### 手动创建正则规则

1. **选择角色**：确保已选择目标角色，扩展会显示当前角色信息
2. **填写脚本名称**：为你的正则规则起一个描述性的名称
3. **编写正则表达式**：
   - 支持标准JavaScript正则语法
   - 支持多行正则表达式
   - 实时验证语法正确性
4. **定义替换内容**：
   - 支持多行文本
   - 完全保留格式和换行符
   - 可使用捕获组引用（$1, $2等）
5. **选择影响范围**：
   - 用户输入和AI输出（推荐）
   - 仅用户输入
   - 仅AI输出
   - 所有内容
6. **测试预览**：在测试文本区域验证正则效果
7. **应用规则**：点击"插入正则表达式"完成创建

### AI辅助生成

#### 配置API
1. 切换到"AI生成"标签页
2. 选择API提供商（Gemini或自定义）
3. 配置相应的API密钥和模型：
   - **Gemini**：需要API Key和模型名称（默认gemini-2.5-pro）
   - **自定义**：需要API URL、API Key和模型名称
4. 配置会自动保存到浏览器，无需重复设置

#### 生成状态栏规则
1. **描述需求**：在提示框中详细描述你想要的状态栏功能
   - 示例："帮我制定一个角色状态栏，显示角色的想法、衣着、身体状态和好感度"
2. **生成内容**：点击"生成正则表达式"，AI会返回：
   - 正则表达式模式
   - 状态栏XML格式
   - 示例正文内容
   - HTML美化页面
3. **预览效果**：
   - 在"正文使用区域"输入测试内容
   - 点击"预览应用效果"查看实际渲染结果
4. **应用结果**：点击"应用到手动创建页面"，内容会自动填充到手动创建表单

#### 对话历史管理
- **自动恢复**：每次打开工具时自动显示上次的对话内容
- **查看历史**：点击"查看对话历史"浏览所有历史记录
- **清空历史**：点击"清空历史"删除所有对话记录
- **多轮对话**：支持连续对话，AI会记住上下文

## 🔧 高级配置

### 扩展设置
- **启用扩展**：控制扩展的总开关
- **显示预览功能**：是否在手动创建模式显示测试预览
- **记住上次的输入**：是否保存用户的输入偏好

### API配置优化
- **自动保存**：所有API配置修改后立即保存
- **多层备份**：配置同时保存到浏览器本地和SillyTavern设置
- **智能恢复**：优先从浏览器本地恢复配置，确保配置不丢失

### 正则规则管理
- **自动集成**：生成的规则自动添加到角色的正则脚本列表
- **实时刷新**：规则添加后立即刷新SillyTavern的正则UI
- **角色绑定**：规则与特定角色关联，切换角色时自动应用对应规则

## 🎯 使用场景

### 角色状态栏增强
- **基础信息显示**：姓名、称号、时间、地点等
- **情感状态追踪**：心情、想法、好感度变化
- **物理状态监控**：健康值、体力、装备状态
- **互动选项提供**：动态生成可选择的行动选项

### 对话格式优化
- **发言者标识**：自动标识不同角色的发言
- **情感色彩渲染**：根据内容自动添加情感标记
- **场景描述增强**：美化环境和动作描述文本

### 内容过滤与转换
- **敏感内容处理**：自动过滤或替换不当内容
- **格式标准化**：统一对话和描述的格式规范
- **多语言支持**：实现文本的多语言转换

## 🛠️ 技术特性

### 架构设计
- **模块化结构**：清晰的功能模块划分，便于维护和扩展
- **事件驱动**：采用事件驱动架构，响应用户操作和系统状态变化
- **异步处理**：所有API调用和文件操作都采用异步模式
- **错误恢复**：完善的错误处理和恢复机制

### 性能优化
- **懒加载**：按需加载功能模块，减少初始化时间
- **缓存机制**：智能缓存API响应和用户配置
- **防抖处理**：用户输入防抖，避免频繁的验证和保存操作
- **内存管理**：自动清理不需要的数据，防止内存泄漏

### 兼容性
- **SillyTavern集成**：深度集成SillyTavern的设置系统和UI框架
- **浏览器兼容**：支持现代浏览器的所有主要功能
- **移动端适配**：响应式设计，完美支持移动设备操作
- **主题适配**：自动适配各种SillyTavern主题

## 🔍 故障排除

### 常见问题

**Q: 扩展无法加载？**
A: 确保文件路径正确，重启SillyTavern，检查浏览器控制台错误信息。

**Q: AI生成功能不工作？**
A: 检查API密钥配置，确认网络连接，查看控制台是否有API调用错误。

**Q: 正则规则没有生效？**
A: 确认角色已选择，检查正则表达式语法，验证规则是否正确添加到角色。

**Q: 配置丢失问题？**
A: 新版本支持自动保存，如遇问题请检查浏览器本地存储权限。

### 调试信息
扩展提供详细的控制台日志，在浏览器开发者工具中查看：
```
[STQuickStatusBar] 相关的日志信息
```

## 🤝 贡献指南

### 开发环境
- SillyTavern开发版本
- 现代浏览器（Chrome 88+, Firefox 85+）
- 基本的JavaScript和CSS知识

### 代码规范
- 遵循ES6+标准
- 使用有意义的变量和函数命名
- 添加详细的注释说明
- 保持代码整洁和模块化

### 测试要求
- 在多个浏览器中测试功能
- 验证移动端响应式效果
- 确保与SillyTavern各版本兼容
- 测试各种边界条件和异常情况

## 📈 更新日志

### v1.0.0 (2025-01-27)
- ✨ 初始版本发布
- 🔧 手动创建模式：完整的正则表达式编辑器
- 🤖 AI生成模式：支持Gemini和自定义API
- 💾 自动保存：API配置实时保存到浏览器
- 🎨 代码包裹：自动为替换内容添加markdown包裹
- 📚 对话历史：多轮对话支持和历史管理
- 🖥️ 现代UI：渐变背景和玻璃形态设计
- 📱 响应式：完美的移动端适配
- 🌙 主题适配：自动适配明暗主题

## 💡 未来计划

- [ ] 支持更多AI模型和API提供商
- [ ] 添加正则模板库和预设规则
- [ ] 实现规则导入导出功能
- [ ] 增加可视化正则构建器
- [ ] 支持正则规则的分组管理
- [ ] 添加性能监控和优化建议
- [ ] 实现云端同步功能

## 📞 支持与反馈

如果你在使用过程中遇到问题或有改进建议，欢迎通过以下方式联系：

- 🐛 **问题报告**：请详细描述问题现象和复现步骤
- 💡 **功能建议**：欢迎提出新功能想法和改进建议
- 📚 **使用咨询**：对使用方法有疑问可以询问

---

## 📄 许可证声明

### 🚫 自定义限制性许可证

**版权所有 © 2025 ST快速状态栏扩展开发者:DayBreak**

#### 使用权限
✅ **允许的使用**：
- 个人非商业使用
- 学习和研究目的
- 在遵守限制条件下的修改和定制

#### 严格限制
❌ **禁止的行为**：
- **禁止未授权修改**：不得修改源代码后进行传播或商业使用
- **禁止商业用途**：不得将本软件用于任何商业目的或营利活动
- **禁止去除版权**：不得移除或修改版权声明和许可证信息

#### 免责声明
本软件按"现状"提供，不提供任何明示或暗示的担保，包括但不限于对适销性、特定用途适用性和非侵权性的担保。在任何情况下，作者或版权持有者均不对任何索赔、损害或其他责任负责，无论是在合同诉讼、侵权行为还是其他方面。

#### 终止条件
如违反本许可证的任何条款，您的使用权将自动终止，必须立即停止使用并删除所有副本。

---

**⚠️ 重要提示：使用本软件即表示您同意并遵守上述所有条款。如不同意，请勿使用本软件。**

---

*让每个角色都拥有生动的状态栏展示！🎭*
